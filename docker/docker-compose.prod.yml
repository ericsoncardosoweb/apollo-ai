version: '3.8'

# ===========================================
# Production Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker/docker-compose.prod.yml up
# ===========================================

services:
  backend:
    build:
      target: production
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  celery-worker:
    build:
      target: production
    environment:
      - ENVIRONMENT=production
    command: celery -A app.workers.celery_app worker --loglevel=warning --concurrency=4
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  celery-beat:
    build:
      target: production
    environment:
      - ENVIRONMENT=production
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

  frontend:
    build:
      target: production
    ports:
      - "80:80"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

  redis:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
